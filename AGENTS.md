# AGENTS

## Scope
- 本文件仅作用于当前 SiYuan Copilot 配置的 `codexWorkingDir`。
- 不读取、不写入全局 AGENTS 文件。
- 默认目标：把每次问答沉淀为可追溯的研究记录、知识笔记和行动项。

## Output Rules
- 每轮必须输出：
  - `进度百分比`
  - `剩余工作量估算`（步数或分钟）
- 关键改动必须附：
  - `最小回归验证`
  - `可执行验证结果`（通过/失败 + 关键输出）

## Core Loop
1. 澄清目标与边界（输入、产出、限制）。
2. 并行收集证据与上下文（代码、文档、数据源）。
3. 产出可执行方案（含风险与回滚点）。
4. 最小改动实施。
5. 执行验证并记录结果。
6. 回写笔记并沉淀可复用知识。

## Skills-driven Workflows

### 1) 调研流程（research + source-management）
- 至少双来源交叉验证，优先官方文档和一手资料。
- 每条结论记录来源：标题、链接、日期、可信度。
- 不确定结论必须标注“待验证”，并给出下一步验证方案。

### 2) 知识沉淀（knowledge-management + memory-management）
- 每次任务结束输出：
  - 背景
  - 结论
  - 决策及理由
  - 风险与边界
  - 后续行动项（owner、截止时间、状态）
- 维护“当前工作记忆”：目标、已完成、阻塞、下一步，避免会话漂移。

### 3) 原子笔记（zettelkasten-note-creation）
- 一条笔记只表达一个核心结论。
- 标题包含关键术语，便于检索。
- 明确双向关联：上游来源、下游应用。
- 新结论优先关联已有笔记，避免重复沉淀。

### 4) 会议纪要（meeting-notes-and-actions / meeting-minutes-taker）
- 会议输出固定结构：
  - 主题与时间
  - 关键讨论点
  - 决策列表
  - 行动项（owner、截止时间、状态）
- 未确认事项标记为“待确认”，禁止写成已决策。

### 5) 文档治理（docs-cleaner）
- 先去重，再合并，再归档。
- 合并后保留原文链接与版本信息，防止溯源丢失。

### 6) 项目可复原记录（必须）
- 调研中出现的外部链接/地址必须保留原始 URL。
- 涉及代码仓库时，必须记录：仓库地址、分支、提交 SHA、关键文件路径。
- 关键步骤不能只贴链接，必须在笔记中保留可执行信息：命令、参数、输入输出示例、依赖版本。
- 关键配置不能只引用外部页面，必须在笔记中落地最小可用配置片段。
- 涉及下载文件时，必须记录：保存路径、文件名、版本、校验值（如 SHA256）。
- 单条调研结论需要同时包含：
  - 来源链接
  - 摘要结论
  - 复现步骤
  - 验证结果
- 目标标准：仅凭笔记内容可还原项目，不需要再回原页面或原仓库找关键信息。

## SiYuan-Specific Rules
- 操作前先确认 `BlockID` 和范围，禁止编造 ID。
- 优先块级精确更新，避免整文覆盖。
- 修改后在同一文档补充：改了什么、为什么改、如何验证。
- 跨文档引用时，写明来源文档与 `BlockID`。
- 涉及脚本/API 写入时，优先给最小影响方案（可先 dry-run）。
- 聊天区已下线“保存到笔记/编辑消息”手动入口；需要沉淀会话内容时，必须通过 MCP 工具写回笔记，不依赖手动按钮流程。

## Codex 图片工作流（仅工具调用，不走手动 UI）
- 优先使用 MCP 工具完成图片任务，不要求用户手动点按钮：
  - `siyuan_import_image_urls`
  - `siyuan_extract_page_images`
  - `siyuan_capture_webpage_screenshot`
  - `siyuan_insert_images_to_note`
- 用户提到“帖子图片/网页图片/页面截图”时，默认流程：
  1. 先抓取或导入图片到资源库。
  2. 再写入指定笔记（`noteBlockId`），并返回写入结果。
  3. 回报图片来源 URL、资源路径、写入块位置信息。
- 必须保留可复原信息：
  - 原始页面 URL
  - 实际图片 URL（或截图服务 URL）
  - 资源路径（asset path）
  - 校验值（SHA256，如工具返回）
- 若外部页面抓取失败，必须给出：
  - 失败原因
  - 已尝试的备选方式
  - 下一步可执行方案（而不是仅报错结束）

## Quality Gate
- 是否给出可点击的来源链接？
- 是否包含最小回归与执行结果？
- 是否生成可复用知识条目和行动项？
- 是否满足 SiYuan 块级更新规范？
- 是否仅靠笔记即可还原项目（不依赖再次访问外部页面）？
